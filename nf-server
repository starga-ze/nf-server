#!/usr/bin/env python3
import sys
import os
import importlib.util

COMMAND_MAP = {
    "build": "script/build.py",
    "clean": "script/clean.py",
    "install": "script/install.py",
    "uninstall": "script/uninstall.py",
    "start": "script/start.py",
    "stop": "script/stop.py",
    "tar": "script/tar.py",
}

NEED_ROOT = {"start", "stop"}


def ensure_root(cmd):
    if cmd not in NEED_ROOT:
        return

    if os.geteuid() == 0:
        return

    print(f"[*] The '{cmd}' command requires root privileges. Restart with sudo ...")

    new_cmd = ["sudo", sys.executable, sys.argv[0]] + sys.argv[1:]
    os.execvp("sudo", new_cmd)


def main():
    if len(sys.argv) < 2:
        print("Usage: ./nf-server [build|clean|install|uninstall|start|stop|tar]")
        sys.exit(1)

    cmd = sys.argv[1]

    ensure_root(cmd)

    module_file = COMMAND_MAP.get(cmd)

    if not module_file:
        print("[*] Error, Unknown command:", cmd)
        sys.exit(1)

    PROJECT_ROOT = os.path.abspath(os.path.dirname(__file__))
    if PROJECT_ROOT not in sys.path:
        sys.path.insert(0, PROJECT_ROOT)

    module_path = os.path.join(PROJECT_ROOT, module_file)
    module_name = module_file.replace('/', '_').replace('.py', '')

    try:
        spec = importlib.util.spec_from_file_location(module_name, module_path)
        if spec is None:
            raise ImportError(f"Could not find spec for {module_path}")

        module = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(module)
    except Exception as e:
        print(f"[Error] Failed to load module {module_file}: {e}")
        print("[*] Check if the file exists in the correct 'script/' subdirectory.")
        sys.exit(1)

    if hasattr(module, "run"):
        module.run()
    else:
        print(f"[*] Error, {module_file} has no run() function")
        sys.exit(1)


if __name__ == "__main__":
    main()
